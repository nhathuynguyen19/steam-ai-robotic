{% extends "auth_base.html" %}
{% block title %}Đặt lại mật khẩu | HUSC AI & Robotics{% endblock %}

{% block content %}

<div class="container d-flex justify-content-center align-items-center py-5" style="min-height: 80vh;">
    <div class="col-md-6 col-lg-4">

        <!-- Logo -->
        <div class="text-center mb-4">
            <img src="/static/images/logo.jpg" alt="Logo"
                 class="rounded-circle border border-3 border-white shadow-sm mb-3"
                 width="80" height="80">
            <h4 class="fw-bold text-dark mb-0">HUSC AI & ROBOTICS</h4>
            <p class="text-muted small">Thiết lập mật khẩu mới</p>
        </div>

        <!-- CARD -->
        <div class="card p-4 shadow-sm border-0 rounded-3 bg-white">
            <div class="card-body">

                <h5 class="card-title text-center mb-3 fw-bold text-primary">
                    Đặt lại mật khẩu
                </h5>

                <p class="text-muted small text-center mb-4">
                    Vui lòng nhập mật khẩu mới cho tài khoản của bạn.
                </p>

                <!-- SNIPPET SHOW ERROR / SUCCESS -->
                <div id="reset-msg"></div>

                <!-- FORM -->
                <form
                    hx-post="/api/auth/reset_password/"
                    hx-target="#reset-msg"
                    hx-swap="innerHTML"
                    onsubmit="return validatePasswords(event)"
                >

                    <!-- Hidden token -->
                    <input type="hidden" name="token" value="{{ token }}">

                    <div class="form-floating mb-3">
                        <input type="password" 
                            class="form-control"
                            id="password"
                            name="new_password"
                            placeholder="Mật khẩu mới"
                            required>
                        <label for="password">Mật khẩu mới</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="password"
                            class="form-control"
                            id="confirm"
                            placeholder="Nhập lại mật khẩu"
                            required>
                        <label for="confirm">Nhập lại mật khẩu</label>
                    </div>

                    <button id="btn-submit" type="submit" class="btn btn-primary w-100 fw-bold py-2 rounded-3">
                        <i class="bi bi-shield-lock me-2"></i> Cập nhật mật khẩu
                    </button>
                </form>

            </div>
        </div>

        <div class="text-center mt-4">
            <a href="/auth/signin" class="text-primary fw-medium small text-decoration-none">
                <i class="bi bi-arrow-left"></i> Quay lại đăng nhập
            </a>
        </div>

    </div>
</div>

<script>
function validatePasswords(e) {
    const pw = document.getElementById("password").value;
    const cf = document.getElementById("confirm").value;

    if (pw !== cf) {
        e.preventDefault();
        e.stopImmediatePropagation();

        document.getElementById("reset-msg").innerHTML = `
            <div class="alert alert-danger text-center">
                Mật khẩu xác nhận không khớp!
            </div>
        `;

        const btn = document.getElementById("btn-submit");
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-shield-lock me-2"></i> Cập nhật mật khẩu`;

        return false;
    }

    const btn = document.getElementById("btn-submit");
    btn.disabled = true;
    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> Đang cập nhật...`;

    return true;
}

// Sau mỗi request, reset lại trạng thái nút submit
document.body.addEventListener("htmx:afterRequest", () => {
    const btn = document.getElementById("btn-submit");
    if (btn) {
        btn.disabled = false;
        btn.innerHTML = `<i class="bi bi-shield-lock me-2"></i> Cập nhật mật khẩu`;
    }
});
</script>

{% endblock %}
