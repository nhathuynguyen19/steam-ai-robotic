<table class="table is-fullwidth is-striped">
  <thead>
    <tr>
      <th>Tr·∫°ng th√°i</th>
      <th>Th·ªùi gian</th>
      <th>S·ª± ki·ªán</th>
      <th>ƒê·ªãa ƒëi·ªÉm</th>
      <th>S·ªë l∆∞·ª£ng</th>
      <th>Thao t√°c (Join/Leave)</th>
      <th>X√°c nh·∫≠n (Check-in)</th>
    </tr>
  </thead>

  <tbody>
  {% for item in events_data %}
    {% set e = item.obj %}
    <tr id="ev-{{ e.event_id }}">
      <td>
        {% if item.show_finished_tag %}
          <span class="tag-finished">FINISHED</span>
        {% else %}
          <span class="tag-ongoing">ONGOING</span>
        {% endif %}
      </td>

      <td>
        <div><strong>{{ e.day_start }}</strong></div>
        <small>Ti·∫øt: {{ e.start_period }} - {{ e.end_period }}</small>
      </td>

      <td>{{ e.name }}</td>
      <td>{{ e.school_name }}</td>
      
      <td>{{ item.participant_count }} / {{ e.max_user_joined }}</td>

      <td>
        {% if item.is_joined %}
          <div>
            <span class="icon-text has-text-success">
              ‚úì ƒê√£ ƒëƒÉng k√Ω ({{ item.user_role }})
            </span>
            
            {% if not e.is_locked and not item.has_checked_in %}
              <button class="button is-small is-danger is-outlined ml-2"
                      hx-post="/api/events/{{ e.event_id }}/leave/"
                      hx-confirm="B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën r·ªùi s·ª± ki·ªán n√†y?"
                      hx-target="#events-table" 
                      hx-swap="innerHTML">
                R·ªùi ƒëi
              </button>
            {% endif %}
          </div>
        {% else %}
          {% if e.is_locked %}
             <span class="has-text-grey">üîí ƒê√£ kh√≥a</span>
          {% else %}
             <details>
                <summary class="button is-small is-primary">ƒêƒÉng k√Ω tham gia</summary>
                <form class="mt-2 box p-2" 
                      hx-post="/api/events/{{ e.event_id }}/join/"
                      hx-target="#events-table" 
                      hx-swap="innerHTML"
                      style="position: absolute; z-index: 10; min-width: 200px;">
                  
                  <input type="hidden" name="event_id" value="{{ e.event_id }}">
                  
                  <div class="field">
                    <label class="label is-small">Vai tr√≤:</label>
                    <div class="control">
                      <div class="select is-small is-fullwidth">
                        <select name="role">
                          <option value="teaching_assistant">Tr·ª£ gi·∫£ng (TA)</option>
                          <option value="instructor">Ng∆∞·ªùi d·∫°y ch√≠nh</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="field mt-2">
                    <button class="button is-small is-success is-fullwidth" type="submit">
                      X√°c nh·∫≠n Join
                    </button>
                  </div>
                </form>
             </details>
          {% endif %}
        {% endif %}
      </td>

      <td>
        {% if item.is_joined %}
            {% if item.has_checked_in %}
                <span class="has-text-success font-weight-bold">ƒê√£ tham gia</span>
            {% else %}
                <form hx-post="/api/events/{{ e.event_id }}/attend/"
                      hx-target="#ev-{{ e.event_id }}"
                      hx-swap="outerHTML"> <label class="checkbox">
                        <input type="checkbox" 
                               {% if not item.is_time_finished %}disabled title="S·ª± ki·ªán ch∆∞a k·∫øt th√∫c"{% endif %}
                               onchange="if(confirm('X√°c nh·∫≠n b·∫°n ƒë√£ tham gia s·ª± ki·ªán n√†y?')) htmx.trigger(this.form, 'submit')">
                        X√°c nh·∫≠n
                    </label>
                </form>
                {% if not item.is_time_finished %}
                    <br><small class="has-text-grey">(M·ªü sau khi h·∫øt gi·ªù)</small>
                {% endif %}
            {% endif %}
        {% else %}
            <span class="has-text-grey">-</span>
        {% endif %}
      </td>
    </tr>
  {% else %}
    <tr>
      <td colspan="7" class="has-text-centered">Kh√¥ng c√≥ s·ª± ki·ªán n√†o trong danh m·ª•c n√†y.</td>
    </tr>
  {% endfor %}
  </tbody>
</table>